<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NISA Lens Mock - Admin</title>
  <link rel="stylesheet" href="nisa_mock.css" />
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <div class="logo">NISA Lens | Admin</div>
      <nav class="nav">
        <a href="nisa_mock.html">入口</a>
        <a href="#posts">投稿管理</a>
        <a href="#reports">通報管理</a>
        <a href="#ops">運営分析</a>
      </nav>
      <a class="btn ghost" href="nisa_user_mock.html">利用者画面</a>
    </header>

    <section class="hero">
      <div class="hero-copy">
        <p class="eyebrow">管理者画面</p>
        <h1>投稿管理と健全性運用</h1>
        <p>審査は行わず即時公開。通報対応、非公開化、CSV出力でコミュニティを維持します。</p>
      </div>
      <div class="hero-panel">
        <h3>運用ポリシー</h3>
        <div class="chips">
          <span>誹謗中傷禁止</span><span>宣伝禁止</span><span>詐欺防止</span><span>URL禁止</span><span>監査ログ</span>
        </div>
      </div>
    </section>

    <section id="posts" class="page">
      <div class="page-head">
        <h2>投稿管理（公開中）</h2>
        <div class="ad">管理広告枠（非表示想定）</div>
      </div>
      <div class="card">
        <table>
          <thead><tr><th>投稿ID</th><th>投稿者/属性</th><th>状態</th><th>操作</th></tr></thead>
          <tbody id="postsBody">
            <tr>
              <td>#P-1204</td>
              <td>nisa_user_01 / 30代 / 会社員 / 投信（海外インデックス）</td>
              <td>published</td>
              <td><button type="button" class="ghost">非公開化</button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section id="reports" class="page">
      <h2>通報管理</h2>
      <div class="card">
        <table>
          <thead><tr><th>通報ID</th><th>対象投稿</th><th>理由</th><th>件数</th><th>対応</th></tr></thead>
          <tbody id="reportsBody">
            <tr><td>#R-88</td><td>#P-1177</td><td>宣伝/勧誘</td><td>4</td><td><button>非公開化</button> <button class="ghost">維持</button></td></tr>
            <tr><td>#R-89</td><td>#P-1181</td><td>誹謗中傷</td><td>2</td><td><button>確認</button></td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section id="ops" class="page">
      <h2>運営分析ダッシュボード</h2>
      <div class="form-actions">
        <button id="exportPublishedCsvBtn" type="button">公開投稿CSV</button>
        <button id="exportReportsCsvBtn" type="button" class="ghost">通報CSV</button>
      </div>
      <p id="exportStatus" class="ga-note"></p>
      <div class="kpi-grid">
        <article class="card kpi"><p class="kpi-label">公開投稿数</p><p class="kpi-value">124</p><p class="kpi-sub">24h</p></article>
        <article class="card kpi"><p class="kpi-label">通報件数</p><p class="kpi-value">17</p><p class="kpi-sub">7日平均</p></article>
        <article class="card kpi"><p class="kpi-label">対応完了率</p><p class="kpi-value">91%</p><p class="kpi-sub">7日平均</p></article>
        <article class="card kpi"><p class="kpi-label">非公開化率</p><p class="kpi-value">8%</p><p class="kpi-sub">通報閾値超え</p></article>
      </div>
      <div class="card" style="margin-top:12px;">
        <h3>流入チャネル</h3>
        <div class="channel-bars">
          <div><span>Organic Search</span><i style="width:46%"></i><b>46%</b></div>
          <div><span>Direct</span><i style="width:28%"></i><b>28%</b></div>
          <div><span>Referral</span><i style="width:14%"></i><b>14%</b></div>
          <div><span>Social</span><i style="width:9%"></i><b>9%</b></div>
          <div><span>Email</span><i style="width:3%"></i><b>3%</b></div>
        </div>
      </div>
      <p class="ga-note">管理者画面は運用監視用途。利用者投稿導線は含めません。</p>
    </section>
  </div>
  <script>
    const publishedKey = "nisaPublishedPosts";
    const reportsKey = "nisaReports";
    const hiddenKey = "nisaHiddenPostIds";
    const postsBody = document.getElementById("postsBody");
    const reportsBody = document.getElementById("reportsBody");
    const exportPublishedCsvBtn = document.getElementById("exportPublishedCsvBtn");
    const exportReportsCsvBtn = document.getElementById("exportReportsCsvBtn");
    const exportStatus = document.getElementById("exportStatus");

    const getStore = (key) => JSON.parse(localStorage.getItem(key) || "[]");
    const setStore = (key, value) => localStorage.setItem(key, JSON.stringify(value));

    const hidePostById = (postId) => {
      const hidden = new Set(getStore(hiddenKey));
      hidden.add(String(postId));
      setStore(hiddenKey, [...hidden]);
      renderPostsRows();
      renderReportRows();
    };

    const resolveReport = (id) => {
      const reports = getStore(reportsKey).map((r) => {
        if (r.id !== id) return r;
        return { ...r, status: "closed" };
      });
      setStore(reportsKey, reports);
      renderReportRows();
    };

    const hidePostFromReport = (reportId) => {
      const reports = getStore(reportsKey);
      const target = reports.find((r) => r.id === reportId);
      if (!target) return;
      hidePostById(target.post_id);
      resolveReport(reportId);
    };

    const renderPostsRows = () => {
      const hiddenIds = new Set(getStore(hiddenKey));
      const published = getStore(publishedKey);
      postsBody.querySelectorAll("tr[data-dynamic='1']").forEach((row) => row.remove());
      if (published.length === 0) return;
      const html = published.map((post) => {
        const isHidden = hiddenIds.has(String(post.id));
        return `
          <tr data-dynamic="1">
            <td>${post.id}</td>
            <td>${post.display_name} / ${post.age} / ${post.occupation} / ${post.main_product}</td>
            <td>${isHidden ? "hidden" : "published"}</td>
            <td>
              <button type="button" class="ghost" data-hide-post="${post.id}" ${isHidden ? "disabled" : ""}>
                ${isHidden ? "非公開済み" : "非公開化"}
              </button>
            </td>
          </tr>
        `;
      }).join("");
      postsBody.insertAdjacentHTML("afterbegin", html);
      postsBody.querySelectorAll("button[data-hide-post]").forEach((btn) => {
        if (btn.disabled) return;
        btn.addEventListener("click", () => hidePostById(btn.dataset.hidePost));
      });
    };

    const renderReportRows = () => {
      const reports = getStore(reportsKey);
      reportsBody.querySelectorAll("tr[data-dynamic='1']").forEach((row) => row.remove());
      if (reports.length === 0) return;
      const html = reports.map((report) => `
        <tr data-dynamic="1">
          <td>${report.id}</td>
          <td>#${report.post_id}</td>
          <td>${report.reason}</td>
          <td>1</td>
          <td>
            <button type="button" class="ghost" data-hide="${report.id}">非公開化</button>
            <button type="button" class="${report.status === "closed" ? "ghost" : ""}" data-resolve="${report.id}">
              ${report.status === "closed" ? "対応済み" : "対応完了"}
            </button>
          </td>
        </tr>
      `).join("");
      reportsBody.insertAdjacentHTML("afterbegin", html);
      reportsBody.querySelectorAll("button[data-hide]").forEach((btn) => {
        btn.addEventListener("click", () => hidePostFromReport(btn.dataset.hide));
      });
      reportsBody.querySelectorAll("button[data-resolve]").forEach((btn) => {
        if (btn.textContent.trim() === "対応済み") return;
        btn.addEventListener("click", () => resolveReport(btn.dataset.resolve));
      });
    };

    const csvEscape = (value) => {
      const text = String(value ?? "");
      return `"${text.replaceAll("\"", "\"\"")}"`;
    };

    const downloadCsv = (filename, headers, rows) => {
      const csv = [
        headers.map(csvEscape).join(","),
        ...rows.map((row) => row.map(csvEscape).join(","))
      ].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    };

    const exportPublishedCsv = () => {
      const hiddenIds = new Set(getStore(hiddenKey));
      const published = getStore(publishedKey).filter((p) => !hiddenIds.has(String(p.id)));
      const rows = published.map((p) => [
        p.id,
        p.display_name,
        p.age,
        p.family,
        p.housing,
        p.occupation,
        p.main_product,
        p.sub_product,
        Number(p.invest_ratio || 0).toFixed(1),
        Number(p.cash_ratio || 0).toFixed(1),
        Number(p.alloc_stock_domestic || 0).toFixed(1),
        Number(p.alloc_stock_foreign || 0).toFixed(1),
        Number(p.alloc_fund_dom_index || 0).toFixed(1),
        Number(p.alloc_fund_for_index || 0).toFixed(1),
        Number(p.alloc_fund_dom_active || 0).toFixed(1),
        Number(p.alloc_fund_for_active || 0).toFixed(1),
        Number(p.alloc_reit || 0).toFixed(1),
        Number(p.alloc_bond_domestic || 0).toFixed(1),
        Number(p.alloc_bond_foreign || 0).toFixed(1),
        Number(p.alloc_fx || 0).toFixed(1),
        Number(p.alloc_gold || 0).toFixed(1),
        Number(p.alloc_other || 0).toFixed(1),
        Number(p.perf_1y || 0).toFixed(1),
        Number(p.perf_since || 0).toFixed(1),
        p.note || "",
        p.status || "published",
        p.created_at || ""
      ]);
      downloadCsv(
        `published_posts_${new Date().toISOString().slice(0, 10)}.csv`,
        [
          "id", "display_name", "age", "family", "housing", "occupation",
          "main_product", "sub_product", "invest_ratio", "cash_ratio",
          "alloc_stock_domestic", "alloc_stock_foreign",
          "alloc_fund_dom_index", "alloc_fund_for_index",
          "alloc_fund_dom_active", "alloc_fund_for_active",
          "alloc_reit", "alloc_bond_domestic", "alloc_bond_foreign",
          "alloc_fx", "alloc_gold", "alloc_other",
          "perf_1y", "perf_since", "note", "status", "created_at"
        ],
        rows
      );
      exportStatus.textContent = `公開投稿CSVを出力しました（${rows.length}件）`;
    };

    const exportReportsCsv = () => {
      const reports = getStore(reportsKey);
      const rows = reports.map((r) => [
        r.id,
        r.post_id,
        r.reason,
        r.note || "",
        r.status || "open",
        r.created_at || ""
      ]);
      downloadCsv(
        `reports_${new Date().toISOString().slice(0, 10)}.csv`,
        ["id", "post_id", "reason", "note", "status", "created_at"],
        rows
      );
      exportStatus.textContent = `通報CSVを出力しました（${rows.length}件）`;
    };

    renderPostsRows();
    renderReportRows();
    exportPublishedCsvBtn.addEventListener("click", exportPublishedCsv);
    exportReportsCsvBtn.addEventListener("click", exportReportsCsv);
  </script>
</body>
</html>
